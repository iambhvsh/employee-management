{% extends '_base.html' %}

{% block title %}Login - {{ CONFIG["COMPANY_NAME"] }}{% endblock %}

{% block body_class %}login-body{% endblock %}

{% block content %}
  <div class="login-theme-toggle theme-toggle-host"></div>
  <!-- Login page with role-based authentication -->
  <div class="login-wrapper">
    <div class="login-card">
      <div class="login-header">
        <div class="login-logo">
          <span class="material-symbols-outlined login-logo-icon">enterprise</span>
        </div>
        <h1>{{ CONFIG["COMPANY_NAME"] }}</h1>
        <p>{{ CONFIG["LABELS"]["LOGIN_SUBTITLE"] }}</p>
      </div>

      <form method="post" action="{{ url_for('login') }}" id="loginForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <div class="form-group">
          <label for="role">Role</label>
          <select
            id="role"
            name="role"
            required
            onchange="updateDepartments()"
          >
            <option value="">Choose your role</option>
            <option value="admin">Admin</option>
            <option value="employee">Employee</option>
          </select>
        </div>

        <div class="form-group" id="departmentGroup" style="display: none">
          <label for="department">Department</label>
          <select
            id="department"
            name="department"
            onchange="updateUsernames()"
          >
            <option value="">Select your department</option>
          </select>
        </div>

        <div class="form-group">
          <label for="username">Username</label>
          <select id="username" name="username" required disabled>
            <option value="">First select a role</option>
          </select>
        </div>

        <div class="form-group">
          <label for="password">Password</label>
          <input
            type="password"
            id="password"
            name="password"
            required
            placeholder="Enter your password"
          />
        </div>

        <button type="submit">Continue</button>
      </form>
    </div>
  </div>
<script type="application/json" id="login-data">{{ {
  "admins": admins,
  "employees": employees,
  "departments": departments,
  "employeeDepartments": employee_departments
} | tojson }}</script>

<script>
  const loginDataElement = document.getElementById('login-data');
  const loginData = loginDataElement ? JSON.parse(loginDataElement.textContent || '{}') : {};
  const admins = Array.isArray(loginData.admins) ? loginData.admins : [];
  const employees = Array.isArray(loginData.employees) ? loginData.employees : [];
  const departments = Array.isArray(loginData.departments) ? loginData.departments : [];
  const employeeDepartments = loginData.employeeDepartments && typeof loginData.employeeDepartments === 'object' ? loginData.employeeDepartments : {};

  function updateDepartments() {
    const role = document.getElementById('role').value;
    const departmentGroup = document.getElementById('departmentGroup');
    const departmentSelect = document.getElementById('department');
    const usernameSelect = document.getElementById('username');

    // Reset username select
    usernameSelect.innerHTML = '<option value="">First select a role</option>';
    usernameSelect.disabled = true;

    if (role === 'admin') {
      // Hide department for admin
      departmentGroup.style.display = 'none';
      departmentSelect.value = '';
      // Directly show admins
      updateUsernames();
    } else if (role === 'employee') {
      // Show department for employees
      departmentGroup.style.display = 'block';
      departmentSelect.innerHTML = '<option value="">Select your department</option>';
      departments.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept;
        option.textContent = dept;
        departmentSelect.appendChild(option);
      });
    } else {
      departmentGroup.style.display = 'none';
    }
  }

  function updateUsernames() {
    const role = document.getElementById('role').value;
    const department = document.getElementById('department').value;
    const usernameSelect = document.getElementById('username');

    usernameSelect.innerHTML = '<option value="">Select your username</option>';

    if (role === 'admin') {
      usernameSelect.disabled = false;
      admins.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        usernameSelect.appendChild(option);
      });
    } else if (role === 'employee' && department) {
      usernameSelect.disabled = false;
      const deptEmployees = employeeDepartments[department] || [];
      deptEmployees.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        usernameSelect.appendChild(option);
      });
    } else if (role === 'employee' && !department) {
      usernameSelect.disabled = true;
      usernameSelect.innerHTML = '<option value="">First select a department</option>';
    } else {
      usernameSelect.disabled = true;
      usernameSelect.innerHTML = '<option value="">First select a role</option>';
    }
  }
</script>
{% endblock %}
